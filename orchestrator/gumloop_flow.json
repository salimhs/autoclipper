{
    "workflow_name": "AutoClipper Video Processing",
    "description": "Convert long-form video to ranked vertical clips with Gumloop LLM (Gemini fallback)",
    "nodes": [
        {
            "node_id": "node_1",
            "name": "URL Validation",
            "type": "custom_code",
            "input_schema": {
                "video_url": "string",
                "job_id": "string"
            },
            "output_schema": {
                "video_url": "string",
                "valid": "boolean",
                "platform": "string"
            },
            "script": "validate_url.py"
        },
        {
            "node_id": "node_2",
            "name": "Download + Audio Extract",
            "type": "custom_code",
            "depends_on": [
                "node_1"
            ],
            "input_schema": {
                "video_url": "string",
                "job_id": "string"
            },
            "output_schema": {
                "video_uri": "string",
                "audio_uri": "string",
                "duration_sec": "number",
                "fps": "number",
                "width": "integer",
                "height": "integer"
            },
            "script": "download_extract.py",
            "tools": [
                "yt-dlp",
                "ffmpeg"
            ]
        },
        {
            "node_id": "node_3a",
            "name": "WhisperX Transcription",
            "type": "custom_code",
            "depends_on": [
                "node_2"
            ],
            "parallel_with": [
                "node_3b"
            ],
            "input_schema": {
                "audio_uri": "string",
                "video_url": "string",
                "duration_sec": "number",
                "job_id": "string"
            },
            "output_schema": {
                "transcript_uri": "string",
                "word_timeline_uri": "string",
                "confidence_stats": "object"
            },
            "script": "whisperx_transcribe.py",
            "requires_gpu": true
        },
        {
            "node_id": "node_3b",
            "name": "Visual Tracking",
            "type": "custom_code",
            "depends_on": [
                "node_2"
            ],
            "parallel_with": [
                "node_3a"
            ],
            "input_schema": {
                "video_uri": "string",
                "video_url": "string",
                "width": "integer",
                "height": "integer",
                "job_id": "string"
            },
            "output_schema": {
                "tracking_uri": "string",
                "crop_paths_uri": "string"
            },
            "script": "visual_tracking.py",
            "requires_gpu": true
        },
        {
            "node_id": "node_3c",
            "name": "Model Router",
            "type": "custom_code",
            "depends_on": [
                "node_3a"
            ],
            "input_schema": {
                "transcript_uri": "string",
                "duration_sec": "number",
                "job_id": "string"
            },
            "output_schema": {
                "strategy": "string",
                "reason": "string",
                "selected_model_name": "string"
            },
            "script": "model_router.py"
        },
        {
            "node_id": "node_4",
            "name": "LLM Clip Selection",
            "type": "gumloop_llm",
            "depends_on": [
                "node_3c"
            ],
            "input_schema": {
                "transcript_uri": "string",
                "duration_sec": "number",
                "strategy": "string",
                "job_id": "string"
            },
            "output_schema": {
                "raw_edl_json": "string"
            },
            "config": {
                "model": "best_reasoning",
                "temperature": 0.3,
                "response_format": "json",
                "fallback_to_custom": true,
                "custom_script": "llm_select_clips.py"
            },
            "system_prompt": "You are an expert video editor. Analyze transcripts and identify viral short-form clip candidates.",
            "prompt_template": "See schemas/edl.json for required output format. Transcript and duration will be loaded from URIs."
        },
        {
            "node_id": "node_4b",
            "name": "Validate EDL Schema",
            "type": "custom_code",
            "depends_on": [
                "node_4"
            ],
            "input_schema": {
                "raw_edl_json": "string",
                "duration_sec": "number",
                "transcript_uri": "string",
                "job_id": "string"
            },
            "output_schema": {
                "valid": "boolean",
                "edl_uri": "string",
                "validation_error": "string"
            },
            "script": "json_validate_edl.py"
        },
        {
            "node_id": "node_4c",
            "name": "Repair EDL",
            "type": "custom_code",
            "depends_on": [
                "node_4b"
            ],
            "conditional": "{{node_4b.valid}} == false",
            "input_schema": {
                "raw_edl_json": "string",
                "validation_error": "string",
                "duration_sec": "number",
                "strategy": "string",
                "job_id": "string"
            },
            "output_schema": {
                "edl_uri": "string"
            },
            "script": "json_repair_edl.py",
            "config": {
                "max_retries": 2
            }
        },
        {
            "node_id": "node_5",
            "name": "Merge Render Recipes",
            "type": "custom_code",
            "depends_on": [
                "node_3a",
                "node_3b",
                "node_4b",
                "node_4c"
            ],
            "input_schema": {
                "edl_uri": "string",
                "word_timeline_uri": "string",
                "crop_paths_uri": "string",
                "video_uri": "string",
                "job_id": "string"
            },
            "output_schema": {
                "render_recipe_uri": "string"
            },
            "script": "merge_render_recipe.py"
        },
        {
            "node_id": "node_6",
            "name": "Dispatch GPU Render",
            "type": "webhook",
            "depends_on": [
                "node_5"
            ],
            "input_schema": {
                "render_recipe_uri": "string",
                "job_id": "string"
            },
            "output_schema": {
                "render_batch_id": "string"
            },
            "webhook_url": "{RENDER_WORKER_URL}/render",
            "method": "POST"
        },
        {
            "node_id": "node_7",
            "name": "Collect Results",
            "type": "webhook_poll",
            "depends_on": [
                "node_6"
            ],
            "input_schema": {
                "render_batch_id": "string",
                "job_id": "string"
            },
            "output_schema": {
                "clips": [
                    {
                        "clip_id": "string",
                        "mp4_url": "string",
                        "score": "number"
                    }
                ]
            },
            "poll_url": "{RENDER_WORKER_URL}/status/{render_batch_id}",
            "poll_interval_sec": 5,
            "timeout_sec": 600
        }
    ],
    "error_handling": {
        "node_4b_validation_failed": {
            "action": "branch_to_repair",
            "target_node": "node_4c",
            "max_retries": 2
        },
        "node_4c_repair_failed": {
            "action": "fail_with_reason",
            "reason": "Could not generate valid EDL after repair attempts"
        },
        "node_3b_no_face": {
            "action": "use_center_crop_fallback"
        },
        "node_4_no_clips": {
            "action": "fail_with_reason",
            "reason": "No viable clips found in transcript"
        },
        "any_node_transient_error": {
            "action": "retry_with_exponential_backoff",
            "max_retries": 3,
            "base_delay_sec": 1,
            "max_delay_sec": 30
        }
    },
    "cleanup": {
        "on_success": {
            "action": "cleanup_temp_files",
            "keep_outputs": [
                "clips",
                "edl_uri",
                "render_recipe_uri"
            ]
        },
        "on_failure": {
            "action": "cleanup_temp_files",
            "keep_outputs": [
                "logs",
                "error_details"
            ]
        }
    },
    "outputs": {
        "job_id": "{{workflow.job_id}}",
        "status": "completed",
        "clips": "{{node_7.clips}}",
        "edl_uri": "{{node_4b.edl_uri || node_4c.edl_uri}}",
        "metadata": {
            "strategy_used": "{{node_3c.strategy}}",
            "model_used": "{{node_3c.selected_model_name}}"
        }
    }
}